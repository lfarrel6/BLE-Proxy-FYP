<!DOCTYPE html>
<html>
<head>
	<title>Device Interface</title>
	<link href="https://fonts.googleapis.com/css?family=Open+Sans|Raleway|Roboto+Slab" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="/scripts/style.css">
	<link rel="stylesheet" type="text/css" href="/scripts/dashboard.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<link rel="icon" href="/assets/favicon.png">
</head>
<body>

	<a class="floating-btn" id="github-btn" href="https://github.com/lfarrel6/BLE-Proxy-FYP"><img src="/assets/GitHub-Mark-64px.png" alt="View on GitHub!"></a>

	<div class="dash-heading">
		<h1 id='dash-title'></h1>
	</div>

	<div class="dash-data-window two-col">
		<img src="/assets/loading.gif" alt="loading" id="loading-gif">
		<div class="serv-disp two-col-left">
			<ul id="services">
			</ul>
		</div>
		<div class="chars-disp two-col-right">
			<h3></h3>
			<ul id="characteristics">
			</ul>
		</div>
	</div>

	<script type="text/javascript">
		$(document).ready(function(){

			console.log('Document loaded, fetching data');
			var splitURL = location.href.split('/');
			var deviceID = splitURL[splitURL.length-1]

			document.getElementById('dash-title').innerHTML = deviceID;

			var ip = splitURL[splitURL.length-2];
			console.log(ip);
			// GET request to /exp makes the CoAP proxy interrogate the device
			$.get(location.href+'/exp', null, function(data){
				document.getElementById('loading-gif').style.padding = 0;
				document.getElementById('loading-gif').style.visibility = 'hidden';

				console.log("DATA RECEIVED @ dash: " + JSON.stringify(data));
				var services = Object.keys(data).length;

				if(services == 0){
					var listItem = document.createElement('li');
					listItem.className = 'bad-news';
					document.getElementById('services').appendChild(listItem);

					listItem.innerHTML = 'PROXY SERVER RETURNED NO SERVICES';
				}else{

					for(var datum in data){

						console.log(datum);

						//data is a json
						//{id: {info json}}

						var listItem = document.createElement('li');
						listItem.className = "peripheral-li";
						document.getElementById('services').appendChild(listItem);

						var button = document.createElement('button');
						button.setAttribute('id',datum);
						button.className = "dashboard-buttons active";
						button.innerHTML = datum;

						//listItem.innerHTML = data[datum];
						listItem.appendChild(button);


						$('#'+datum).click(function(){
							$.get(location.href+'/'+$(this).prop('id')+'/getChars',null,function(characteristics){
								console.log('RESPONSE: '+JSON.stringify(characteristics));
								var charJSON = JSON.parse(characteristics);
								for(var c in charJSON){
									console.log(c);
									var newLI = document.createElement('li');
									document.getElementById("characteristics").appendChild(newLI);

									var charBtn = document.createElement('button');
									charBtn.setAttribute('id',c);
									charBtn.className='dashboard-buttons active';
									charBtn.innerHTML = charJSON[c];

									newLI.appendChild(charBtn);
								}
							});
						});
					}
				}
			}, 'json');
		});
	</script>

</body>
</html>